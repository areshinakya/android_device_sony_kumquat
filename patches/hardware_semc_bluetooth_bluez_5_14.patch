diff -Nbur a/hardware/semc/bluetooth/bluez/android/Android.mk bluez/android/Android.mk
--- a/hardware/semc/bluetooth/bluez/android/Android.mk	2014-01-24 10:17:40.586453860 +0100
+++ b/hardware/semc/bluetooth/bluez/android/Android.mk	2014-01-23 14:06:23.156928225 +0100
@@ -4,11 +4,14 @@
 BLUEZ_VERSION := $(shell grep ^AC_INIT $(LOCAL_PATH)/../configure.ac | cpp -P -D'AC_INIT(_,v)=v')
 
 # Specify pathmap for glib
-pathmap_INCL += glib:external/bluetooth/glib
+pathmap_INCL += $(LOCAL_PATH)/../../glib/include
 
 # Specify common compiler flags
 BLUEZ_COMMON_CFLAGS := -DVERSION=\"$(BLUEZ_VERSION)\" \
+	-DPLATFORM_SDK_VERSION=$(PLATFORM_SDK_VERSION) \
 	-DANDROID_STORAGEDIR=\"/data/misc/bluetooth\" \
+	-DHAVE_CONFIG_H \
+	-DANDROID
 
 # Disable warnings enabled by Android but not enabled in autotools build
 BLUEZ_COMMON_CFLAGS += -Wno-pointer-arith -Wno-missing-field-initializers
@@ -48,8 +51,7 @@
 	../profiles/network/bnep.c \
 
 LOCAL_C_INCLUDES := \
-	$(call include-path-for, glib) \
-	$(call include-path-for, glib)/glib \
+	$(LOCAL_PATH)/../../glib/include
 
 LOCAL_C_INCLUDES += \
 	$(LOCAL_PATH)/../ \
@@ -71,6 +73,7 @@
 	rfcomm.h \
 	sco.h \
 	bnep.h \
+	cmtp.h
 
 $(shell mkdir -p $(LOCAL_PATH)/../lib/bluetooth)
 
@@ -109,7 +112,7 @@
 LOCAL_MODULE_PATH := $(TARGET_OUT_SHARED_LIBRARIES)/hw
 LOCAL_MODULE_TAGS := optional
 LOCAL_MODULE_CLASS := SHARED_LIBRARIES
-LOCAL_REQUIRED_MODULES := bluetoothd bluetoothd-snoop init.bluetooth.rc
+LOCAL_REQUIRED_MODULES := bluetoothd init.bluetooth.rc
 
 include $(BUILD_SHARED_LIBRARY)
 
@@ -132,9 +135,15 @@
 	client/if-hh.c \
 	client/if-pan.c \
 	client/if-sock.c \
-	client/if-gatt.c \
 	hal-utils.c \
 
+ANDROID_4_3_OR_ABOVE := $(shell echo 0 | awk -v v=$(PLATFORM_SDK_VERSION) 'END {print (v > 17) ? 1 : 0}')
+
+ifeq ($(ANDROID_4_3_OR_ABOVE), 1)
+LOCAL_SRC_FILES += \
+	client/if-gatt.c
+endif
+
 LOCAL_C_INCLUDES += \
 	$(call include-path-for, system-core) \
 	$(call include-path-for, libhardware) \
@@ -150,71 +159,6 @@
 include $(BUILD_EXECUTABLE)
 
 #
-# btmon
-#
-
-include $(CLEAR_VARS)
-
-LOCAL_SRC_FILES := \
-	../monitor/main.c \
-	../monitor/mainloop.c \
-	../monitor/display.c \
-	../monitor/hcidump.c \
-	../monitor/btsnoop.c \
-	../monitor/control.c \
-	../monitor/packet.c \
-	../monitor/l2cap.c \
-	../monitor/uuid.c \
-	../monitor/sdp.c \
-	../monitor/vendor.c \
-	../monitor/lmp.c \
-	../monitor/crc.c \
-	../monitor/ll.c \
-	../monitor/hwdb.c \
-	../monitor/ellisys.c \
-	../monitor/analyze.c \
-	../src/shared/util.c \
-	../src/shared/queue.c \
-	../lib/hci.c \
-	../lib/bluetooth.c \
-
-LOCAL_C_INCLUDES := \
-	$(LOCAL_PATH)/.. \
-	$(LOCAL_PATH)/../lib \
-	$(LOCAL_PATH)/../src/shared \
-
-LOCAL_CFLAGS := $(BLUEZ_COMMON_CFLAGS)
-
-LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)
-LOCAL_MODULE_TAGS := debug
-LOCAL_MODULE := btmon
-
-include $(BUILD_EXECUTABLE)
-
-#
-# btproxy
-#
-
-include $(CLEAR_VARS)
-
-LOCAL_SRC_FILES := \
-	../tools/btproxy.c \
-	../monitor/mainloop.c \
-	../src/shared/util.c \
-
-LOCAL_C_INCLUDES := \
-	$(LOCAL_PATH)/.. \
-	$(LOCAL_PATH)/../src/shared \
-
-LOCAL_CFLAGS := $(BLUEZ_COMMON_CFLAGS)
-
-LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)
-LOCAL_MODULE_TAGS := debug
-LOCAL_MODULE := btproxy
-
-include $(BUILD_EXECUTABLE)
-
-#
 # A2DP audio
 #
 
@@ -255,31 +199,9 @@
 
 LOCAL_CFLAGS := $(BLUEZ_COMMON_CFLAGS)
 
-LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)
-LOCAL_MODULE_TAGS := debug
-LOCAL_MODULE := l2test
-
-include $(BUILD_EXECUTABLE)
-
-#
-# bluetoothd-snoop
-#
-
-include $(CLEAR_VARS)
-
-LOCAL_SRC_FILES := \
-	bluetoothd-snoop.c \
-	../monitor/mainloop.c \
-	../src/shared/btsnoop.c \
-
-LOCAL_C_INCLUDES := \
-	$(LOCAL_PATH)/.. \
-	$(LOCAL_PATH)/../lib \
-
-LOCAL_CFLAGS := $(BLUEZ_COMMON_CFLAGS)
-
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
 LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE := bluetoothd-snoop
+LOCAL_MODULE := l2test
 
 include $(BUILD_EXECUTABLE)
 
diff -Nbur a/hardware/semc/bluetooth/bluez/android/client/haltest.c bluez/android/client/haltest.c
--- a/hardware/semc/bluetooth/bluez/android/client/haltest.c	2014-01-16 21:41:56.307659951 +0100
+++ b/hardware/semc/bluetooth/bluez/android/client/haltest.c	2014-01-21 12:47:55.169638816 +0100
@@ -34,9 +34,11 @@
 	&audio_if,
 	&bluetooth_if,
 	&av_if,
+#if PLATFORM_SDK_VERSION > 17
 	&gatt_if,
 	&gatt_client_if,
 	&gatt_server_if,
+#endif
 	&hf_if,
 	&hh_if,
 	&pan_if,
@@ -385,7 +387,9 @@
 		BT_PROFILE_HEALTH_ID,
 		BT_PROFILE_HIDHOST_ID,
 		BT_PROFILE_PAN_ID,
+#if PLATFORM_SDK_VERSION > 17
 		BT_PROFILE_GATT_ID,
+#endif
 		BT_PROFILE_SOCKETS_ID
 	};
 	const struct method *m;
diff -Nbur a/hardware/semc/bluetooth/bluez/android/client/if-bt.c bluez/android/client/if-bt.c
--- a/hardware/semc/bluetooth/bluez/android/client/if-bt.c	2014-01-16 21:41:56.311659951 +0100
+++ b/hardware/semc/bluetooth/bluez/android/client/if-bt.c	2014-01-21 12:47:55.173638816 +0100
@@ -307,11 +307,13 @@
 	haltest_info("%s\n", __func__);
 }
 
+#if PLATFORM_SDK_VERSION > 17
 static void le_test_mode_cb(bt_status_t status, uint16_t num_packets)
 {
 	haltest_info("%s %s %d\n", __func__, bt_status_t2str(status),
 								num_packets);
 }
+#endif
 
 static bt_callbacks_t bt_callbacks = {
 	.size = sizeof(bt_callbacks),
@@ -326,7 +328,9 @@
 	.acl_state_changed_cb = acl_state_changed_cb,
 	.thread_evt_cb = thread_evt_cb,
 	.dut_mode_recv_cb = dut_mode_recv_cb,
+#if PLATFORM_SDK_VERSION > 17
 	.le_test_mode_cb = le_test_mode_cb
+#endif
 };
 
 static void init_p(int argc, const char **argv)
@@ -722,8 +726,10 @@
 		BT_PROFILE_SOCKETS_ID,
 		BT_PROFILE_HIDHOST_ID,
 		BT_PROFILE_PAN_ID,
+#if PLATFORM_SDK_VERSION > 17
 		BT_PROFILE_GATT_ID,
 		BT_PROFILE_AV_RC_ID,
+#endif
 		NULL
 	};
 
@@ -759,10 +765,12 @@
 		pif = (const void **) &if_hh;
 	else if (strcmp(BT_PROFILE_PAN_ID, id) == 0)
 		pif = (const void **) &if_pan;
+#if PLATFORM_SDK_VERSION > 17
 	else if (strcmp(BT_PROFILE_AV_RC_ID, id) == 0)
 		pif = &dummy; /* TODO: change when if_rc is there */
 	else if (strcmp(BT_PROFILE_GATT_ID, id) == 0)
 		pif = (const void **) &if_gatt;
+#endif
 	else
 		haltest_error("%s is not correct for get_profile_interface\n",
 									id);
@@ -794,11 +802,14 @@
 	haltest_error("not implemented\n");
 }
 
+#if PLATFORM_SDK_VERSION > 17
 static void le_test_mode_p(int argc, const char **argv)
 {
 	haltest_error("not implemented\n");
 }
+#endif
 
+#if PLATFORM_SDK_VERSION > 18
 static void config_hci_snoop_log_p(int argc, const char **argv)
 {
 	uint8_t mode;
@@ -814,6 +825,7 @@
 
 	EXEC(if_bluetooth->config_hci_snoop_log, mode);
 }
+#endif
 
 static struct method methods[] = {
 	STD_METHOD(init),
@@ -839,8 +851,12 @@
 	STD_METHODCH(get_profile_interface, "<profile id>"),
 	STD_METHODH(dut_mode_configure, "<dut mode>"),
 	STD_METHOD(dut_mode_send),
+#if PLATFORM_SDK_VERSION > 17
 	STD_METHOD(le_test_mode),
+#endif
+#if PLATFORM_SDK_VERSION > 18
 	STD_METHODH(config_hci_snoop_log, "<mode>"),
+#endif
 	END_METHOD
 };
 
diff -Nbur a/hardware/semc/bluetooth/bluez/android/client/if-gatt.c bluez/android/client/if-gatt.c
--- a/hardware/semc/bluetooth/bluez/android/client/if-gatt.c	2014-01-16 21:41:56.311659951 +0100
+++ b/hardware/semc/bluetooth/bluez/android/client/if-gatt.c	2014-01-21 12:47:55.173638816 +0100
@@ -26,9 +26,16 @@
  * btgatt_char_id_t -> btgatt_gatt_id_t
  * bt_uuid_t        -> btgatt_gatt_id_t
  */
+#if PLATFORM_SDK_VERSION > 18
 #define str2btgatt_descr_id_t str2btgatt_gatt_id_t
 #define btgatt_descr_id_t2str btgatt_gatt_id_t2str
 #define btgatt_descr_id_t btgatt_gatt_id_t
+#else
+#define btgatt_descr_id_t2str gatt_uuid_t2str
+#define str2btgatt_descr_id_t(a, b) gatt_str2bt_uuid_t(a, -1, b)
+#define btgatt_gatt_id_t btgatt_char_id_t
+#define btgatt_descr_id_t bt_uuid_t
+#endif
 
 #define MAX_CHAR_ID_STR_LEN (MAX_UUID_STR_LEN + 3 + 11)
 #define MAX_SRVC_ID_STR_LEN (MAX_UUID_STR_LEN + 3 + 11 + 1 + 11)
diff -Nbur a/hardware/semc/bluetooth/bluez/android/client/if-main.h bluez/android/client/if-main.h
--- a/hardware/semc/bluetooth/bluez/android/client/if-main.h	2014-01-16 21:41:56.311659951 +0100
+++ b/hardware/semc/bluetooth/bluez/android/client/if-main.h	2014-01-21 12:47:55.173638816 +0100
@@ -37,11 +37,13 @@
 #include <hardware/bt_hf.h>
 #include <hardware/bt_hl.h>
 
+#if PLATFORM_SDK_VERSION > 17
 #include <hardware/bt_rc.h>
 #include <hardware/bt_gatt.h>
 #include <hardware/bt_gatt_types.h>
 #include <hardware/bt_gatt_client.h>
 #include <hardware/bt_gatt_server.h>
+#endif
 
 extern audio_hw_device_t *if_audio;
 
@@ -52,9 +54,11 @@
 extern const bthh_interface_t *if_hh;
 extern const btpan_interface_t *if_pan;
 extern const btsock_interface_t *if_sock;
+#if PLATFORM_SDK_VERSION > 17
 extern const btgatt_interface_t *if_gatt;
 extern const btgatt_server_interface_t *if_gatt_server;
 extern const btgatt_client_interface_t *if_gatt_client;
+#endif
 
 /*
  * Structure defines top level interfaces that can be used in test tool
@@ -68,9 +72,11 @@
 extern const struct interface audio_if;
 extern const struct interface bluetooth_if;
 extern const struct interface av_if;
+#if PLATFORM_SDK_VERSION > 17
 extern const struct interface gatt_if;
 extern const struct interface gatt_client_if;
 extern const struct interface gatt_server_if;
+#endif
 extern const struct interface pan_if;
 extern const struct interface sock_if;
 extern const struct interface hf_if;
diff -Nbur a/hardware/semc/bluetooth/bluez/android/hal-bluetooth.c bluez/android/hal-bluetooth.c
--- a/hardware/semc/bluetooth/bluez/android/hal-bluetooth.c	2014-01-17 23:02:24.423437784 +0100
+++ b/hardware/semc/bluetooth/bluez/android/hal-bluetooth.c	2014-01-21 12:47:55.177638816 +0100
@@ -143,6 +143,7 @@
 			enum_prop_to_hal(send_props[i], prop,
 							bt_device_type_t);
 			break;
+#if PLATFORM_SDK_VERSION > 17
 		case HAL_PROP_DEVICE_VERSION_INFO:
 		{
 			static bt_remote_version_t e;
@@ -158,6 +159,7 @@
 			e.version = p->version;
 		}
 			break;
+#endif
 		case HAL_PROP_DEVICE_SERVICE_REC:
 		{
 			static bt_service_record_t e;
@@ -232,7 +234,7 @@
 	DBG("");
 
 	if (bt_hal_cbacks->pin_request_cb)
-		bt_hal_cbacks->pin_request_cb(addr, name, ev->class_of_dev);
+		bt_hal_cbacks->pin_request_cb(addr, name, ev->class_of_dev, 0);
 }
 
 static void handle_ssp_request(void *buf, uint16_t len)
@@ -338,6 +340,7 @@
 		bt_hal_cbacks->dut_mode_recv_cb(ev->opcode, ev->data, ev->len);
 }
 
+#if PLATFORM_SDK_VERSION > 17
 static void handle_le_test_mode(void *buf, uint16_t len)
 {
 	struct hal_ev_le_test_mode *ev = buf;
@@ -347,6 +350,7 @@
 	if (bt_hal_cbacks->le_test_mode_cb)
 		bt_hal_cbacks->le_test_mode_cb(ev->status, ev->num_packets);
 }
+#endif
 
 /* handlers will be called from notification thread context,
  * index in table equals to 'opcode - HAL_MINIMUM_EVENT' */
@@ -404,11 +408,13 @@
 		.var_len = true,
 		.data_len = sizeof(struct hal_ev_dut_mode_receive),
 	},
+#if PLATFORM_SDK_VERSION > 17
 	{	/* HAL_EV_LE_TEST_MODE */
 		.handler = handle_le_test_mode,
 		.var_len = false,
 		.data_len = sizeof(struct hal_ev_le_test_mode),
 	}
+#endif
 };
 
 static int init(bt_callbacks_t *callbacks)
@@ -798,6 +804,7 @@
 					sizeof(cmd_buf), cmd, 0, NULL, NULL);
 }
 
+#if PLATFORM_SDK_VERSION > 17
 static int le_test_mode(uint16_t opcode, uint8_t *buf, uint8_t len)
 {
 	uint8_t cmd_buf[sizeof(struct hal_cmd_le_test_mode) + len];
@@ -815,7 +822,9 @@
 	return hal_ipc_cmd(HAL_SERVICE_ID_BLUETOOTH, HAL_OP_LE_TEST_MODE,
 					sizeof(cmd_buf), cmd, 0, NULL, NULL);
 }
+#endif
 
+#if PLATFORM_SDK_VERSION > 18
 static int config_hci_snoop_log(uint8_t enable)
 {
 	const char *property;
@@ -831,6 +840,7 @@
 
 	return BT_STATUS_SUCCESS;
 }
+#endif
 
 static const bt_interface_t bluetooth_if = {
 	.size = sizeof(bt_interface_t),
@@ -856,8 +866,12 @@
 	.get_profile_interface = get_profile_interface,
 	.dut_mode_configure = dut_mode_configure,
 	.dut_mode_send = dut_mode_send,
+#if PLATFORM_SDK_VERSION > 17
 	.le_test_mode = le_test_mode,
+#endif
+#if PLATFORM_SDK_VERSION > 18
 	.config_hci_snoop_log = config_hci_snoop_log,
+#endif
 };
 
 static const bt_interface_t *get_bluetooth_interface(void)
diff -Nbur a/hardware/semc/bluetooth/bluez/android/hal-utils.c bluez/android/hal-utils.c
--- a/hardware/semc/bluetooth/bluez/android/hal-utils.c	2014-01-16 21:41:56.335659952 +0100
+++ b/hardware/semc/bluetooth/bluez/android/hal-utils.c	2014-01-21 12:47:55.181638816 +0100
@@ -125,7 +125,9 @@
 	DELEMENT(BT_PROPERTY_ADAPTER_DISCOVERY_TIMEOUT),
 	DELEMENT(BT_PROPERTY_REMOTE_FRIENDLY_NAME),
 	DELEMENT(BT_PROPERTY_REMOTE_RSSI),
+#if PLATFORM_SDK_VERSION > 17
 	DELEMENT(BT_PROPERTY_REMOTE_VERSION_INFO),
+#endif
 	DELEMENT(BT_PROPERTY_REMOTE_DEVICE_TIMESTAMP),
 ENDMAP
 
diff -Nbur a/hardware/semc/bluetooth/bluez/android/main.c bluez/android/main.c
--- a/hardware/semc/bluetooth/bluez/android/main.c	2014-01-17 23:02:24.423437784 +0100
+++ b/hardware/semc/bluetooth/bluez/android/main.c	2014-01-21 12:47:55.189638817 +0100
@@ -56,6 +56,12 @@
 #include "a2dp.h"
 #include "pan.h"
 
+/* TODO: Consider to remove PLATFORM_SDKVERSION check if requirement
+*  for minimal Android platform version increases. */
+#if defined(ANDROID) && PLATFORM_SDK_VERSION >= 18
+#include <sys/capability.h>
+#endif
+
 #define STARTUP_GRACE_SECONDS 5
 #define SHUTDOWN_GRACE_SECONDS 10
 
diff -Nbur a/hardware/semc/bluetooth/bluez/android/Makefile.am bluez/android/Makefile.am
--- a/hardware/semc/bluetooth/bluez/android/Makefile.am	2014-01-24 10:17:40.586453860 +0100
+++ b/hardware/semc/bluetooth/bluez/android/Makefile.am	2014-01-23 14:06:23.156928225 +0100
@@ -66,7 +66,8 @@
 					android/hal-ipc.h android/hal-ipc.c \
 					android/hal-utils.h android/hal-utils.c
 
-android_bluetooth_default_la_CFLAGS = $(AM_CFLAGS) -I$(srcdir)/android
+android_bluetooth_default_la_CFLAGS = $(AM_CFLAGS) -I$(srcdir)/android \
+					-DPLATFORM_SDK_VERSION=19
 android_bluetooth_default_la_LDFLAGS = $(AM_LDFLAGS) -module -avoid-version \
 					-no-undefined
 
@@ -93,6 +94,7 @@
 				android/hal-utils.h android/hal-utils.c
 
 android_haltest_CFLAGS = $(AM_CFLAGS) -I$(srcdir)/android \
+				-DPLATFORM_SDK_VERSION=19 \
 				-DPLUGINDIR=\""$(android_plugindir)"\"
 
 android_haltest_LDFLAGS = -pthread -ldl
diff -Nbur a/hardware/semc/bluetooth/bluez/android/README bluez/android/README
--- a/hardware/semc/bluetooth/bluez/android/README	2014-01-17 23:02:24.399437783 +0100
+++ b/hardware/semc/bluetooth/bluez/android/README	2014-01-21 12:47:55.161638815 +0100
@@ -9,8 +9,6 @@
 More details about BlueZ for Android architecture and components can be found
 in android/hal-apc-api.txt file.
 
-Supported Android version: 4.4
-
 ===============================
 Building and running on Android
 ===============================
diff -Nbur a/hardware/semc/bluetooth/bluez/Android.mk bluez/Android.mk
--- a/hardware/semc/bluetooth/bluez/Android.mk	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/Android.mk	2014-01-21 12:47:55.125638814 +0100
@@ -0,0 +1,18 @@
+#
+# Copyright (C) 2013 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+ifeq ($(BOARD_HAVE_BLUETOOTH),true)
+  include $(all-subdir-makefiles)
+endif
diff -Nbur a/hardware/semc/bluetooth/bluez/btio/Android.mk bluez/btio/Android.mk
--- a/hardware/semc/bluetooth/bluez/btio/Android.mk	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/btio/Android.mk	2014-01-21 12:56:11.913659519 +0100
@@ -0,0 +1,30 @@
+LOCAL_PATH:= $(call my-dir)
+
+#
+# libbtio
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	btio.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../gdbus \
+	$(call include-path-for, glib) \
+	$(LOCAL_PATH)/../../glib/include \
+
+LOCAL_SHARED_LIBRARIES := \
+	libcutils \
+	libglib \
+	libbluetooth \
+
+LOCAL_MODULE:=libbtio
+
+LOCAL_MODULE_TAGS:=optional
+
+include $(BUILD_SHARED_LIBRARY)
diff -Nbur a/hardware/semc/bluetooth/bluez/config.h bluez/config.h
--- a/hardware/semc/bluetooth/bluez/config.h	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/config.h	2014-01-21 12:47:55.209638817 +0100
@@ -0,0 +1,11 @@
+#ifndef SOCK_CLOEXEC
+#define SOCK_CLOEXEC	02000000
+#endif
+
+#ifndef SOCK_NONBLOCK
+#define SOCK_NONBLOCK	04000
+#endif
+
+#ifndef EPOLL_CLOEXEC
+#define EPOLL_CLOEXEC	02000000
+#endif
diff -Nbur a/hardware/semc/bluetooth/bluez/gdbus/Android.mk bluez/gdbus/Android.mk
--- a/hardware/semc/bluetooth/bluez/gdbus/Android.mk	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/gdbus/Android.mk	2014-01-21 12:47:55.237638819 +0100
@@ -0,0 +1,18 @@
+LOCAL_PATH:= $(call my-dir)
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	client.c mainloop.c object.c watch.c polkit.c
+
+LOCAL_CFLAGS+=-O3 -DNEED_DBUS_WATCH_GET_UNIX_FD -Wno-missing-field-initializers -Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../lib \
+	$(call include-path-for, glib) \
+	$(call include-path-for, dbus) \
+	$(LOCAL_PATH)/../../glib/include \
+	$(LOCAL_PATH)/../../../../../device/sony/$(TARGET_DEVICE)/hardware
+
+LOCAL_MODULE:=libgdbus_static
+
+include $(BUILD_STATIC_LIBRARY)
diff -Nbur a/hardware/semc/bluetooth/bluez/lib/Android.mk bluez/lib/Android.mk
--- a/hardware/semc/bluetooth/bluez/lib/Android.mk	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/lib/Android.mk	2014-01-21 12:47:55.245638819 +0100
@@ -0,0 +1,22 @@
+LOCAL_PATH:= $(call my-dir)
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	bluetooth.c \
+	hci.c \
+	sdp.c \
+	uuid.c \
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/bluetooth \
+
+LOCAL_SHARED_LIBRARIES := \
+	libcutils \
+	liblog \
+
+LOCAL_MODULE:=libbluetooth
+
+LOCAL_CFLAGS += -O3 -Wno-missing-field-initializers -Wno-pointer-arith -DHAVE_CONFIG_H
+
+include $(BUILD_SHARED_LIBRARY)
diff -Nbur a/hardware/semc/bluetooth/bluez/monitor/mainloop.c bluez/monitor/mainloop.c
--- a/hardware/semc/bluetooth/bluez/monitor/mainloop.c	2014-01-16 21:41:56.427659956 +0100
+++ b/hardware/semc/bluetooth/bluez/monitor/mainloop.c	2014-01-21 12:47:55.277638820 +0100
@@ -76,7 +76,7 @@
 {
 	unsigned int i;
 
-	epoll_fd = epoll_create1(EPOLL_CLOEXEC);
+	epoll_fd = epoll_create(MAX_MAINLOOP_ENTRIES);
 
 	for (i = 0; i < MAX_MAINLOOP_ENTRIES; i++)
 		mainloop_list[i] = NULL;
diff -Nbur a/hardware/semc/bluetooth/bluez/plugins/Android.mk bluez/plugins/Android.mk
--- a/hardware/semc/bluetooth/bluez/plugins/Android.mk	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/plugins/Android.mk	2014-01-21 13:10:10.213694458 +0100
@@ -0,0 +1,44 @@
+LOCAL_PATH:= $(call my-dir)
+
+#
+# libplugin
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	autopair.c \
+	external-dummy.c \
+	hostname.c \
+	neard.c \
+	policy.c \
+	wiimote.c \
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-DBLUETOOTH_PLUGIN_BUILTIN \
+	-DSTORAGEDIR=\"/data/misc/bluetoothd\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../btio \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../src \
+	$(call include-path-for, glib) \
+	$(call include-path-for, dbus) \
+	$(LOCAL_PATH)/../../glib/include \
+	$(LOCAL_PATH)/../../../../../device/sony/$(TARGET_DEVICE)/hardware \
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth \
+	libcutils \
+	libdbus \
+	libglib \
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_SHARED_LIBRARIES)/bluez-plugin
+LOCAL_UNSTRIPPED_PATH := $(TARGET_OUT_SHARED_LIBRARIES_UNSTRIPPED)/bluez-plugin
+LOCAL_MODULE:=libbuiltinplugin
+
+include $(BUILD_STATIC_LIBRARY)
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/Android.mk bluez/tools/Android.mk
--- a/hardware/semc/bluetooth/bluez/tools/Android.mk	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/Android.mk	2014-01-21 13:03:23.213677495 +0100
@@ -0,0 +1,324 @@
+LOCAL_PATH:= $(call my-dir)
+
+#
+# hciattach
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	hciattach.c \
+	hciattach_st.c \
+	hciattach_ti.c \
+	hciattach_tialt.c \
+	hciattach_ath3k.c \
+	hciattach_qualcomm.c \
+	hciattach_intel.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=hciattach
+
+include $(BUILD_EXECUTABLE)
+
+#
+# hciconfig
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	hciconfig.c \
+	csr.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools \
+	$(LOCAL_PATH)/../src
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=hciconfig
+
+include $(BUILD_EXECUTABLE)
+
+#
+# hcitool
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	hcitool.c \
+	../src/oui.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-DSTORAGEDIR=\"/data/misc/bluetoothd\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools \
+	$(LOCAL_PATH)/../src \
+	$(LOCAL_PATH)/../../glib/include
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth libglib
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=hcitool
+
+include $(BUILD_EXECUTABLE)
+
+#
+# hcidump
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	hcidump.c \
+	parser/parser.c \
+	parser/lmp.c \
+	parser/hci.c \
+	parser/l2cap.c \
+	parser/amp.c \
+	parser/smp.c \
+	parser/att.c \
+	parser/sdp.c \
+	parser/rfcomm.c \
+	parser/bnep.c \
+	parser/cmtp.c \
+	parser/hidp.c \
+	parser/hcrp.c \
+	parser/avdtp.c \
+	parser/avctp.c \
+	parser/avrcp.c \
+	parser/sap.c \
+	parser/obex.c \
+	parser/capi.c \
+	parser/ppp.c \
+	parser/tcpip.c \
+	parser/ericsson.c \
+	parser/csr.c \
+	parser/bpa.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=hcidump
+
+include $(BUILD_EXECUTABLE)
+
+#
+# rfcomm
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	rfcomm.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=rfcomm
+
+include $(BUILD_EXECUTABLE)
+
+#
+# rctest
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	rctest.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=rctest
+
+include $(BUILD_EXECUTABLE)
+
+#
+# l2ping
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	l2ping.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=l2ping
+
+include $(BUILD_EXECUTABLE)
+
+#
+# sdptool
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	sdptool.c \
+	../src/sdp-xml.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../src \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools \
+	$(LOCAL_PATH)/../../glib/include
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=sdptool
+
+include $(BUILD_EXECUTABLE)
+
+#
+# ciptool
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	ciptool.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=ciptool
+
+include $(BUILD_EXECUTABLE)
+
+#
+# bccmd
+#
+
+include $(CLEAR_VARS)
+
+LOCAL_SRC_FILES:= \
+	bccmd.c \
+	csr.c \
+	csr_hci.c \
+	csr_usb.c \
+	csr_h4.c \
+	csr_3wire.c \
+	csr_bcsp.c \
+	ubcsp.c
+
+LOCAL_CFLAGS:= \
+	-DVERSION=\"5.14\" \
+	-Wno-missing-field-initializers \
+	-Wno-pointer-arith
+
+LOCAL_C_INCLUDES:= \
+	$(LOCAL_PATH)/../ \
+	$(LOCAL_PATH)/../lib \
+	$(LOCAL_PATH)/../tools
+
+LOCAL_SHARED_LIBRARIES := \
+	libbluetooth
+
+LOCAL_MODULE_PATH := $(TARGET_OUT_EXECUTABLES)
+LOCAL_MODULE_TAGS := optional
+LOCAL_MODULE:=bccmd
+
+include $(BUILD_EXECUTABLE)
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/ciptool.c bluez/tools/ciptool.c
--- a/hardware/semc/bluetooth/bluez/tools/ciptool.c	2014-01-16 21:41:56.559659961 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/ciptool.c	2014-01-21 12:47:55.389638825 +0100
@@ -44,6 +44,8 @@
 #include <bluetooth/sdp_lib.h>
 #include <bluetooth/cmtp.h>
 
+#include "ppoll.h"
+
 static volatile sig_atomic_t __io_canceled = 0;
 
 static void sig_hup(int sig)
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/hciattach.c bluez/tools/hciattach.c
--- a/hardware/semc/bluetooth/bluez/tools/hciattach.c	2014-01-16 21:41:56.567659962 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/hciattach.c	2014-01-21 12:47:55.397638825 +0100
@@ -48,6 +48,8 @@
 
 #include "hciattach.h"
 
+#include "ppoll.h"
+
 struct uart_t {
 	char *type;
 	int  m_id;
@@ -1075,6 +1077,10 @@
 	{ "texasalt",   0x0000, 0x0000, HCI_UART_LL,   115200, 115200,
 				FLOW_CTL, DISABLE_PM, NULL, texasalt, NULL   },
 
+	/* ST-Ericsson CG2900 GPS FM Bluetooth combo controller */
+	{ "cg2900",     0x0000, 0x0000, HCI_UART_STE,  115200, 115200,
+				FLOW_CTL, DISABLE_PM, NULL, NULL     },
+
 	/* ST Microelectronics minikits based on STLC2410/STLC2415 */
 	{ "st",         0x0000, 0x0000, HCI_UART_H4,    57600, 115200,
 				FLOW_CTL, DISABLE_PM,  NULL, st       },
@@ -1178,10 +1184,10 @@
 }
 
 /* Initialize UART driver */
-static int init_uart(char *dev, struct uart_t *u, int send_break, int raw)
+static int init_uart(char *dev, struct uart_t *u, int send_break, int raw, int line_disc)
 {
 	struct termios ti;
-	int fd, i;
+	int fd;
 	unsigned long flags = 0;
 
 	if (raw)
@@ -1241,8 +1247,7 @@
 	}
 
 	/* Set TTY to N_HCI line discipline */
-	i = N_HCI;
-	if (ioctl(fd, TIOCSETD, &i) < 0) {
+	if (ioctl(fd, TIOCSETD, &line_disc) < 0) {
 		perror("Can't set line discipline");
 		return -1;
 	}
@@ -1267,7 +1272,7 @@
 {
 	printf("hciattach - HCI UART driver initialization utility\n");
 	printf("Usage:\n");
-	printf("\thciattach [-n] [-p] [-b] [-r] [-t timeout] [-s initial_speed] <tty> <type | id> [speed] [flow|noflow] [bdaddr]\n");
+	printf("\thciattach [-n] [-p] [-a line_disc_nr] [-b] [-r] [-t timeout] [-s initial_speed] <tty> <type | id> [speed] [flow|noflow] [bdaddr]\n");
 	printf("\thciattach -l\n");
 }
 
@@ -1276,6 +1281,7 @@
 	struct uart_t *u = NULL;
 	int detach, printpid, raw, opt, i, n, ld, err;
 	int to = 10;
+	int line_disc = N_HCI;
 	int init_speed = 0;
 	int send_break = 0;
 	pid_t pid;
@@ -1288,8 +1294,11 @@
 	printpid = 0;
 	raw = 0;
 
-	while ((opt=getopt(argc, argv, "bnpt:s:lr")) != EOF) {
+	while ((opt=getopt(argc, argv, "bnpt:s:lra:")) != EOF) {
 		switch(opt) {
+		case 'a':
+			line_disc = atoi(optarg);
+			break;
 		case 'b':
 			send_break = 1;
 			break;
@@ -1405,7 +1414,7 @@
 	alarm(to);
 	bcsp_max_retries = to;
 
-	n = init_uart(dev, u, send_break, raw);
+	n = init_uart(dev, u, send_break, raw, line_disc);
 	if (n < 0) {
 		perror("Can't initialize device");
 		exit(1);
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/hciattach.h bluez/tools/hciattach.h
--- a/hardware/semc/bluetooth/bluez/tools/hciattach.h	2014-01-16 21:41:56.567659962 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/hciattach.h	2014-01-21 12:47:55.397638825 +0100
@@ -39,6 +39,7 @@
 #define HCI_UART_H4DS	3
 #define HCI_UART_LL	4
 #define HCI_UART_ATH3K  5
+#define HCI_UART_STE 6
 
 #define HCI_UART_RAW_DEVICE	0
 #define HCI_UART_RESET_ON_INIT	1
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/parser/tcpip.c bluez/tools/parser/tcpip.c
--- a/hardware/semc/bluetooth/bluez/tools/parser/tcpip.c	2014-01-16 21:41:56.599659963 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/parser/tcpip.c	2014-01-21 13:01:45.893673439 +0100
@@ -43,6 +43,7 @@
 
 void arp_dump(int level, struct frame *frm)
 {
+#if 0
 	int i;
 	char buf[20];
 	struct sockaddr_in sai;
@@ -67,6 +68,7 @@
 	printf("(%s)\n", buf);
 	frm->ptr += sizeof(struct ether_arp);
 	frm->len -= sizeof(struct ether_arp);
+#endif
 	raw_dump(level, frm);		// not needed.
 }
 
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/ppoll.h bluez/tools/ppoll.h
--- a/hardware/semc/bluetooth/bluez/tools/ppoll.h	1970-01-01 01:00:00.000000000 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/ppoll.h	2014-01-21 12:47:55.433638827 +0100
@@ -0,0 +1,16 @@
+#ifdef ppoll
+#undef ppoll
+#endif
+
+#define ppoll compat_ppoll
+
+static inline int compat_ppoll(struct pollfd *fds, nfds_t nfds,
+		const struct timespec *timeout, const sigset_t *sigmask)
+{
+	if (timeout == NULL)
+		return poll(fds, nfds, -1);
+	else if (timeout->tv_sec == 0)
+		return poll(fds, nfds, 500);
+	else
+		return poll(fds, nfds, timeout->tv_sec * 1000);
+}
diff -Nbur a/hardware/semc/bluetooth/bluez/tools/rfcomm.c bluez/tools/rfcomm.c
--- a/hardware/semc/bluetooth/bluez/tools/rfcomm.c	2014-01-16 21:41:56.599659963 +0100
+++ b/hardware/semc/bluetooth/bluez/tools/rfcomm.c	2014-01-21 12:47:55.433638827 +0100
@@ -45,6 +45,8 @@
 #include <bluetooth/hci_lib.h>
 #include <bluetooth/rfcomm.h>
 
+#include "ppoll.h"
+
 static int rfcomm_raw_tty = 0;
 static int auth = 0;
 static int encryption = 0;
